<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin-paneeli - Tarinat</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-form {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            margin: 0 auto;
        }
        
        .admin-dashboard {
            display: none;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .admin-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .action-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .admin-table {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .admin-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .admin-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .admin-table td {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .admin-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .admin-button:hover {
            background: #c82333;
        }
        
        .admin-button.secondary {
            background: #6c757d;
        }
        
        .admin-button.secondary:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>üõ°Ô∏è Admin-paneeli</h1>
            <p>Tarinat-sivuston hallinta</p>
        </div>

        <!-- Kirjautumislomake -->
        <div id="loginSection" class="login-form">
            <h3>Kirjaudu sis√§√§n</h3>
            <form id="adminLoginForm">
                <div class="form-group">
                    <label for="adminPassword">Admin-salasana:</label>
                    <input type="password" id="adminPassword" name="salasana" required>
                </div>
                <button type="submit">Kirjaudu sis√§√§n</button>
            </form>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="admin-dashboard">
            <!-- Tilastot -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="tarinatCount">-</div>
                    <div>Tarinat</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="kommentitCount">-</div>
                    <div>Kommentit</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="tagitCount">-</div>
                    <div>Tagit</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="yhteensaCount">-</div>
                    <div>Yhteens√§</div>
                </div>
            </div>

            <!-- Toiminnot -->
            <div class="admin-actions">
                <div class="action-card">
                    <h4>üìñ Tarinoiden hallinta</h4>
                    <p>Hallitse ja moderoi tarinoita</p>
                    <button class="admin-button" onclick="naytaTarinat()">N√§yt√§ tarinat</button>
                </div>
                
                <div class="action-card">
                    <h4>üí¨ Kommenttien hallinta</h4>
                    <p>Hallitse ja moderoi kommentteja</p>
                    <button class="admin-button" onclick="naytaKommentit()">N√§yt√§ kommentit</button>
                </div>
                
                <div class="action-card">
                    <h4>üè∑Ô∏è Tagien hallinta</h4>
                    <p>Hallitse ja moderoi tageja</p>
                    <button class="admin-button" onclick="naytaTagit()">N√§yt√§ tagit</button>
                </div>
                
                <div class="action-card">
                    <h4>üîÑ P√§ivit√§ tiedot</h4>
                    <p>Lataa uusimmat tilastot</p>
                    <button class="admin-button secondary" onclick="paivitaTilastot()">P√§ivit√§</button>
                </div>
            </div>

            <!-- Sis√§lt√∂taulukko -->
            <div id="adminContent" class="admin-table" style="display: none;">
                <table>
                    <thead id="tableHeader"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>

            <!-- Uloskirjautuminen -->
            <div style="text-align: center; margin-top: 30px;">
                <button class="admin-button secondary" onclick="uloskirjaudu()">Kirjaudu ulos</button>
                <a href="/" style="margin-left: 20px;">‚Üê Takaisin etusivulle</a>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        
        // Kirjautuminen
        document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const salasana = formData.get('salasana');
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ salasana })
                });
                
                if (response.ok) {
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('adminDashboard').style.display = 'block';
                    await lataaAdminTiedot();
                } else {
                    const error = await response.json();
                    alert('Kirjautuminen ep√§onnistui: ' + error.error);
                }
            } catch (error) {
                alert('Kirjautuminen ep√§onnistui: ' + error.message);
            }
        });

        // Lataa admin-tiedot
        async function lataaAdminTiedot() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/dashboard`);
                if (response.ok) {
                    const data = await response.json();
                    
                    document.getElementById('tarinatCount').textContent = data.tilastot.tarinat;
                    document.getElementById('kommentitCount').textContent = data.tilastot.kommentit;
                    document.getElementById('tagitCount').textContent = data.tilastot.tagit;
                    document.getElementById('yhteensaCount').textContent = data.tilastot.yhteensa;
                }
            } catch (error) {
                console.error('Tietojen lataus ep√§onnistui:', error);
            }
        }

        // P√§ivit√§ tilastot
        async function paivitaTilastot() {
            await lataaAdminTiedot();
            alert('Tilastot p√§ivitetty!');
        }

        // N√§yt√§ tarinat
        async function naytaTarinat() {
            try {
                const response = await fetch(`${API_BASE}/api/tarinat`);
                const tarinat = await response.json();
                
                const header = document.getElementById('tableHeader');
                const body = document.getElementById('tableBody');
                
                header.innerHTML = `
                    <tr>
                        <th>Numero</th>
                        <th>Nimimerkki</th>
                        <th>Teksti</th>
                        <th>Luotu</th>
                        <th>Toiminnot</th>
                    </tr>
                `;
                
                body.innerHTML = tarinat.map(tarina => `
                    <tr>
                        <td>#${tarina.numero}</td>
                        <td>${tarina.nimimerkki}</td>
                        <td>${tarina.teksti.substring(0, 100)}...</td>
                        <td>${new Date(tarina.luotu).toLocaleString('fi-FI')}</td>
                        <td>
                            <button class="admin-button" onclick="poistaTarina('${tarina._id}')">üóëÔ∏è Poista</button>
                        </td>
                    </tr>
                `).join('');
                
                document.getElementById('adminContent').style.display = 'block';
            } catch (error) {
                alert('Tarinoiden lataus ep√§onnistui: ' + error.message);
            }
        }

        // N√§yt√§ kommentit
        async function naytaKommentit() {
            try {
                // Hae kaikki kommentit kaikista tarinoista
                const tarinatResponse = await fetch(`${API_BASE}/api/tarinat`);
                const tarinat = await tarinatResponse.json();
                
                let kaikkirommentit = [];
                for (const tarina of tarinat) {
                    const kommentitResponse = await fetch(`${API_BASE}/api/tarinat/${tarina._id}/kommentit`);
                    const kommentit = await kommentitResponse.json();
                    kaikkirommentit = kaikkirommentit.concat(kommentit.map(k => ({...k, tarinaNumero: tarina.numero})));
                }
                
                const header = document.getElementById('tableHeader');
                const body = document.getElementById('tableBody');
                
                header.innerHTML = `
                    <tr>
                        <th>Numero</th>
                        <th>Tarina</th>
                        <th>Nimimerkki</th>
                        <th>Teksti</th>
                        <th>Luotu</th>
                        <th>Toiminnot</th>
                    </tr>
                `;
                
                body.innerHTML = kaikkirommentit.map(kommentti => `
                    <tr>
                        <td>#${kommentti.numero}</td>
                        <td>#${kommentti.tarinaNumero}</td>
                        <td>${kommentti.nimimerkki}</td>
                        <td>${kommentti.teksti.substring(0, 100)}...</td>
                        <td>${new Date(kommentti.luotu).toLocaleString('fi-FI')}</td>
                        <td>
                            <button class="admin-button" onclick="poistaKommentti('${kommentti._id}')">üóëÔ∏è Poista</button>
                        </td>
                    </tr>
                `).join('');
                
                document.getElementById('adminContent').style.display = 'block';
            } catch (error) {
                alert('Kommenttien lataus ep√§onnistui: ' + error.message);
            }
        }

        // N√§yt√§ tagit
        async function naytaTagit() {
            try {
                const tarinatResponse = await fetch(`${API_BASE}/api/tarinat`);
                const tarinat = await tarinatResponse.json();
                
                let kaikkiragit = [];
                for (const tarina of tarinat) {
                    const tagitResponse = await fetch(`${API_BASE}/api/tarinat/${tarina._id}/tagit`);
                    const tagit = await tagitResponse.json();
                    kaikkiragit = kaikkiragit.concat(tagit.map(t => ({...t, tarinaNumero: tarina.numero})));
                }
                
                const header = document.getElementById('tableHeader');
                const body = document.getElementById('tableBody');
                
                header.innerHTML = `
                    <tr>
                        <th>Tagi</th>
                        <th>Tarina</th>
                        <th>Luoja</th>
                        <th>üëç</th>
                        <th>üëé</th>
                        <th>Luotu</th>
                        <th>Toiminnot</th>
                    </tr>
                `;
                
                body.innerHTML = kaikkiragit.map(tagi => `
                    <tr>
                        <td>#${tagi.nimi}</td>
                        <td>#${tagi.tarinaNumero}</td>
                        <td>${tagi.luoja}</td>
                        <td>${tagi.positiivisetAanet}</td>
                        <td>${tagi.negatiivisetAanet}</td>
                        <td>${new Date(tagi.luotu).toLocaleString('fi-FI')}</td>
                        <td>
                            <button class="admin-button" onclick="alert('Tagi-poisto ei ole viel√§ k√§yt√∂ss√§')">üóëÔ∏è Poista</button>
                        </td>
                    </tr>
                `).join('');
                
                document.getElementById('adminContent').style.display = 'block';
            } catch (error) {
                alert('Tagien lataus ep√§onnistui: ' + error.message);
            }
        }

        // Poista tarina (Admin)
        async function poistaTarina(tarinaId) {
            if (!confirm('Haluatko varmasti poistaa t√§m√§n tarinan? T√§m√§ poistaa my√∂s kaikki sen kommentit ja tagit!')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/tarinat/${tarinaId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Tarina poistettu onnistuneesti!');
                    naytaTarinat(); // P√§ivit√§ listaus
                    paivitaTilastot(); // P√§ivit√§ tilastot
                } else {
                    const error = await response.json();
                    alert('Poisto ep√§onnistui: ' + error.error);
                }
            } catch (error) {
                alert('Poisto ep√§onnistui: ' + error.message);
            }
        }

        // Poista kommentti (Admin)
        async function poistaKommentti(kommenttiId) {
            if (!confirm('Haluatko varmasti poistaa t√§m√§n kommentin?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/kommentit/${kommenttiId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Kommentti poistettu onnistuneesti!');
                    naytaKommentit(); // P√§ivit√§ listaus
                    paivitaTilastot(); // P√§ivit√§ tilastot
                } else {
                    const error = await response.json();
                    alert('Poisto ep√§onnistui: ' + error.error);
                }
            } catch (error) {
                alert('Poisto ep√§onnistui: ' + error.message);
            }
        }

        // Uloskirjautuminen
        function uloskirjaudu() {
            // Poista admin-cookie asettamalla se vanhaksi
            document.cookie = 'adminSession=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            
            // N√§yt√§ kirjautumislomake
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('adminContent').style.display = 'none';
            
            // Tyhjenn√§ lomake
            document.getElementById('adminPassword').value = '';
        }

        // Tarkista onko jo kirjautunut (sivun latauksen yhteydess√§)
        window.addEventListener('load', async () => {
            try {
                const response = await fetch(`${API_BASE}/api/admin/dashboard`);
                if (response.ok) {
                    // Jos p√§√§see dashboard-sivulle, on jo kirjautunut
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('adminDashboard').style.display = 'block';
                    await lataaAdminTiedot();
                }
            } catch (error) {
                // Jos ei p√§√§se, n√§ytet√§√§n kirjautumislomake (oletustila)
            }
        });
    </script>
</body>
</html>
